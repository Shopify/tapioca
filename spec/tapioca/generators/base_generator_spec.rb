# typed: true
# frozen_string_literal: true

require "spec_helper"
require "generator_spec"
require "tapioca/generators/base_generator"

module Tapioca
  module Generators
    class BaseGeneratorSpec < GeneratorSpec
      describe "#rbi_header" do
        it "displays when config.file_header is true" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.rbi_header("bin/tapioca dsl")
          expected = <<~RUBY
            # DO NOT EDIT MANUALLY
            # This is an autogenerated file for .
            # Please instead update this file by running `bin/tapioca dsl`.

          RUBY
          assert_equal(expected, result)
        end

        it "doesn't display when config.file_header is false" do
          config = ConfigBuilder.from_options(:dsl, { "file_header" => false })
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.rbi_header("bin/tapioca dsl")
          expected = ""
          assert_equal(expected, result)
        end

        it "displays the correct information when reason is set" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.rbi_header("bin/tapioca dsl", reason: "foo")
          expected = <<~RUBY
            # DO NOT EDIT MANUALLY
            # This is an autogenerated file for foo.
            # Please instead update this file by running `bin/tapioca dsl`.

          RUBY
          assert_equal(expected, result)
        end

        it "displays the correct information when strictness is set" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.rbi_header("bin/tapioca dsl", strictness: "true")
          expected = <<~RUBY
            # DO NOT EDIT MANUALLY
            # This is an autogenerated file for .
            # Please instead update this file by running `bin/tapioca dsl`.

            # typed: true

          RUBY
          assert_equal(expected, result)
        end

        it "displays the correct information when reason and strictness are set" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.rbi_header("bin/tapioca dsl", reason: "foo", strictness: "true")
          expected = <<~RUBY
            # DO NOT EDIT MANUALLY
            # This is an autogenerated file for foo.
            # Please instead update this file by running `bin/tapioca dsl`.

            # typed: true

          RUBY
          assert_equal(expected, result)
        end
      end

      describe "#dsl_rbi_filename" do
        it "provides the correct filename for single-word constant names" do
          constant = "Constant"
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.dsl_rbi_filename(constant)
          expected = config.outpath / "constant.rbi"
          assert_equal(expected, result)
        end

        it "provides the correct filename for multi-word constant names" do
          constant = "ThisIsMyTestConstant"
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.dsl_rbi_filename(constant)
          expected = config.outpath / "this_is_my_test_constant.rbi"
          assert_equal(expected, result)
        end
      end

      describe "#constantize" do
        it "returns an empty array when constants aren't found" do
          skip
          constants = ["Foo", "Bar", "Baz"]
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.constantize(constants)
          expected = []
          assert_equal(expected, result)
        end

        it "returns an array of filepaths when constants are found" do
          skip
          constants = ["Foo", "Bar", "Baz"]
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.constantize(constants)
          expected = [config.outpath / "foo.rbi", config.outpath / "bar.rbi", config.outpath / "baz.rbi"]
          assert_equal(expected, result)
        end
      end

      describe "#existing_rbi_filenames" do
        before do
          Bundler.with_unbundled_env do
            IO.popen(["bundle", "install", "--quiet"], chdir: @repo_path).read
            IO.popen(["bundle", "exec", "tapioca", "dsl"], chdir: @repo_path).read
          end
        end

        it "returns all RBI filenames if no constant is requested" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.existing_rbi_filenames([])
          expected = [].to_set # TODO: This should be populated with all RBIs so we should have some
          assert_equal(expected, result)
        end

        it "returns only the specified RBI if the constant is requested" do
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.existing_rbi_filenames(["Foo"])
          expected = [Pathname.new("sorbet/rbi/dsl/foo.rbi")].to_set
          assert_equal(expected, result)
        end
      end

      describe "#remove" do
        it "does nothing when filename doesn't exist" do
          fake_filename = repo_path / "foo.rb"
          refute_path_exists(fake_filename)
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          generator.remove(fake_filename)
          refute_path_exists(fake_filename)
        end

        it "removes the file if it exists" do
          filename = repo_path / "disposable.rb"
          File.write(filename, <<~RUBY)
            # typed: true
            module Disposable
            end
          RUBY
          assert_path_exists(filename)
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          generator.remove(filename)
          refute_path_exists(filename)
        end
      end

      describe "#underscore" do
        it "works for singular classes" do
          klass = "FooBar"
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.underscore(klass)
          expected = "foo_bar"
          assert_equal(expected, result)
        end

        it "works for nested classes" do
          klass = "FooBar::Baz"
          config = ConfigBuilder.from_options(:dsl, {})
          generator = Tapioca::Generators::BaseGenerator.new(config)
          result = generator.underscore(klass)
          expected = "foo_bar/baz"
          assert_equal(expected, result)
        end
      end
    end
  end
end
